!function(e,t){function n(){this.sheets={},this.dependencies={}}function r(e){function t(){var n=e.substr(m);if(!n)return"EOF";var r,i;if(r=W.exec(n))return m+=r[0].length,t();if(r=A.exec(n))i=new s("boolean",r[0].toLowerCase());else if(r=k.exec(n))i=new s("string",JSON.parse(r[0]));else if(r=E.exec(n))i=new s("number",r[0]);else if(r=V.exec(n))i=new s("funcopen",r[1]);else if(r=D.exec(n))i=new s("sheetref",r[1]);else if(r=U.exec(n))i=new s("ident",r[0].toUpperCase());else if(r=N.exec(n))i=new s("rparen",")");else if(r=O.exec(n))i=new s("lparen","(");else if(r=R.exec(n))i=new s("binop_times",r[0]);else if(r=P.exec(n))i=new s("binop_add",r[0]);else if(r=F.exec(n))i=new s("binop_comp",r[0]);else if(r=q.exec(n))i=new s("comma",",");else if(r=T.exec(n))i=new s("percent","%");else{if(!(r=L.exec(n)))throw new SyntaxError("Unknown token: "+n);i=new s("colon",":")}return r&&(m+=r[0].length),i}function n(){return v=v||t()}function r(){var e=v||t();return v=null,e}function i(e){var t=n();return t&&t.type===e?r():null}function a(e){var t=r();if(t.type!==e)throw new SyntaxError("Expected "+e+", got "+t.type);return t}function h(){var e;if(e=i("boolean"))return new o("boolean",{value:"true"===e.value});if(e=i("number")){var t=e.value,n=parseFloat(e.value);return i("percent")&&(t+="%",n/=100),new o("number",{value:n,raw:t})}if(e=i("string"))return new o("string",{value:e.value});if(e=i("ident")){var r=U.exec(e.value);return new o("identifier",{value:r[2]+r[4],pinRow:"$"===r[3],pinCol:"$"===r[1],raw:e.value})}throw new SyntaxError("Unrecognized primitive value")}function l(){var e=h();if(!e||"identifier"!==e.type)return e;if(i("colon")){var t=a("ident");e=new o("range",{start:e,end:new o("identifier",{value:t.value})})}return e}function c(){var e=i("funcopen");if(!e)return l();for(var t=[];n()&&!i("rparen");)t.length&&a("comma"),t.push(w());return new o("function",{name:e.value,args:t})}function u(){var e=i("sheetref");return e?new o("sheetlookup",{sheet:e.value,content:l()}):c()}function p(){if(!i("lparen"))return u();var e=w();return a("rparen"),e}function d(){var e=p(),t=i("binop_times");return t?new o("*"===t.value?"binop_mult":"/"===t.value?"binop_div":"binop_expon",{left:e,operator:t.value,right:d()}):e}function f(){var e=d(),t=i("binop_add");return t?new o("+"===t.value?"binop_add":"&"===t.value?"binop_concat":"binop_sub",{left:e,operator:t.value,right:f()}):e}function g(){var e=f(),t=i("binop_comp");if(!t)return e;var n;switch(t.value){case"<":n="binop_comp_lt";break;case"<=":n="binop_comp_lte";break;case">":n="binop_comp_gt";break;case">=":n="binop_comp_gte";break;case"=":n="binop_comp_eq";break;case"<>":n="binop_comp_neq"}return new o(n,{left:e,operator:t.value,right:g()})}function w(){return g()}var v,m=0;return w()}function i(e,t,n){Q[n||t]=e[t].bind(e)}function a(e,t){for(var n,t=[],r=0;r<t.length;r++)n=t[r].run(sheet),n&&"object"==typeof n?t=t.concat(n):t.push(n);if(e=e.toLowerCase(),e in Q)return Q[e].apply(null,t);var i,a;switch(e){case"and":return t.map(x).reduce(function(e,t){return e&&t});case"average":return i=t.filter(b),i.length?i.reduce(w)/i.length:0;case"averagea":return t.map(x).reduce(w)/t.length;case"code":case"asc":return t[0].toString().charCodeAt(0)||0;case"chr":case"combin":return g(t[0])/g(t[0]-t[1]);case"concatenate":return t.reduce(function(e,t){return e.toString()+t.toString()});case"count":return t.filter(b).length;case"counta":return t.filter(function(e){return""!==e&&null!==e&&void 0!==e}).length;case"countblank":return t.filter(function(e){return""===e}).length;case"countif":return t.filter(function(e){return e==t[1]}).length;case"degrees":return 57.2957795*t[0];case"dollar":return"$"+m(0|t[0])+(t[1]?"."+parseFloat(t[0]).toFixed(t[1]).split(".")[1]:"");case"even":return 2*Math.ceil(t[0]/2);case"exact":return t[0].toString()===t[1].toString();case"fact":return g(t[0]);case"factdouble":return g(t[0],2);case"search":case"find":return t[1].toString().substr((t[2]||1)-1).indexOf(t[0].toString());case"fixed":return(t[2]?M:m)(t[0])+(t[1]?"."+parseFloat(t[0]).toFixed(t[1]).split(".")[1]:"");case"frequency":return t.slice(0,-1).filter(function(e){return e<=t[t.length-1]}).length;case"if":return t[0]?t[1]:t[2];case"isblank":return""===t[0]||null===t[0];case"iseven":return t[0]%2===0;case"isnottext":return"string"!=typeof t[0];case"isnumber":return"number"==typeof t[0];case"isodd":return t[0]%2!==0;case"istext":return"string"==typeof t[0];case"large":return t.slice(0,-1).sort().reverse()[t[t.length-1]];case"lower":case"lcase":return t[0].toString().toLowerCase();case"left":return t[0].toString().substr(0,t[1]||1);case"len":return t[0].toString().length;case"max":return Math.max.apply(Math,t.filter(b));case"maxa":return Math.max.apply(Math,t.map(x));case"median":return i=t.map(parseFloat).sort(),i.length%2===0?(i[(i.length-1)/2|0]+i[Math.ceil((i.length-1)/2)])/2:i[(i.length-1)/2];case"mid":return t[0].toString().substr((t[1]||1)-1,t[2]);case"min":return Math.min.apply(Math,t.filter(b));case"mina":return Math.min.apply(Math,t.map(x));case"mod":return t[0]%t[1];case"not":return!t[0];case"or":return t.reduce(function(e,t){return e||t});case"pi":return Math.PI;case"product":return t.reduce(function(e,t){return e*t});case"proper":return t[0].toString().split(/\s/).map(function(e){return e[0].toUpperCase()+e.substr(1)});case"quotient":return t[0]/t[1]|0;case"radians":return t[0]/57.2957795;case"randbetween":return Math.random()*(t[1]-t[0])+t[0];case"replace":return t[0].toString().substr(0,t[1]-1)+t[3].toString()+t[0].toString().substr(t[1]-1+t[2]);case"rept":return new Array(t[1]+1).join(t[0].toString());case"right":return t[0].toString().substr(-1*t[1]||-1);case"round":return Math.round(t[0]||0).toFixed(t[1]||0);case"fix":case"rounddown":return t[0]<0?Math.ceil(t[0]):Math.floor(t[0]);case"roundup":return t[0]>0?Math.ceil(t[0]):Math.floor(t[0]);case"sign":return t[0]/Math.abs(t[0])||0;case"space":return new Array(t[0]+1).join(" ");case"sqrtpi":return Math.sqrt(t[0]*Math.PI);case"stdev":return i=t.filter(b).map(x),a=i.reduce(w)/i.length,Math.sqrt(i.map(function(e){return Math.pow(e-a,2)}).reduce(w)/(i.length-1));case"stdeva":return i=t.map(x),a=i.reduce(w)/i.length,Math.sqrt(i.map(function(e){return Math.pow(e-a,2)}).reduce(w)/(i.length-1));case"stdevp":return i=t.filter(b).map(x),a=i.reduce(w)/i.length,Math.sqrt(i.map(function(e){return Math.pow(e-a,2)}).reduce(w)/i.length);case"stdevpa":return i=t.map(x),a=i.reduce(w)/i.length,Math.sqrt(i.map(function(e){return Math.pow(e-a,2)}).reduce(w)/i.length);case"t":case"str":return t[0].toString();case"sum":return t.map(x).reduce(w);case"upper":case"ucase":return t[0].toString().toUpperCase();case"value":case"val":return(/^\d+/.exec(t[0].toString().replace(/\s/g,""))||[""])[0];case"var":return i=t.filter(b).map(x),a=i.reduce(w)/i.length,i.map(function(e){return Math.pow(e-a,2)}).reduce(w)/(i.length-1);case"vara":return i=t.map(x),a=i.reduce(w)/i.length,i.map(function(e){return Math.pow(e-a,2)}).reduce(w)/(i.length-1);case"varp":return i=t.filter(b).map(x),a=i.reduce(w)/i.length,i.map(function(e){return Math.pow(e-a,2)}).reduce(w)/i.length;case"varpa":return i=t.map(x),a=i.reduce(w)/i.length,i.map(function(e){return Math.pow(e-a,2)}).reduce(w)/i.length}}function s(e,t){this.type=e,this.value=t}function o(e,t){this.type=e;for(var n in t)this[n]=t[n]}function h(e,t){for(var n=u(e.start.value),r=u(e.end.value),i=Math.min(n.row,r.row),a=Math.max(n.row,r.row),s=Math.min(n.col,r.col),o=Math.max(n.col,r.col),h=i;a>=h;h++)for(var l=s;o>=l;l++)t(h,l)}function l(t,n){this.elem=t,this.elem.className="websheet",n=S(n||{},z),C(this,n),this.columnWidths=[];for(var r=0;r<n.width;r++)this.columnWidths[r]=$;this.data=[],this.calculated=[],this.formatting=[],this.depUpdateQueue=null,this.dependencies={},this.dependants={},this.cellCache={},this.dragType=I,this.dragSource=null,d(e,"mouseup",this._windowMouseup=function(){this.dragType!==I&&(this.dragType=I,this.dragSource=null,this.elem.className="websheet")}.bind(this)),this.valueUpdates=new p,this.calculatedUpdates=new p,this.context=n.context||null,this.name=null}function c(e,t){var n,r="";e+=1;do n=t%26,t-=n,t/=26,r=String.fromCharCode(n+65)+r;while(t);return r+e}function u(e){if(e in J)return J[e];for(var t,n=/^([a-z]+)([0-9]+)$/i.exec(e),r=n[1],i=0;r;)t=r.charCodeAt(0)-65,i*=26,i+=t,r=r.substr(1);var a={col:i,row:n[2]-1};return J[e]=a,a}function p(){var e={},t=[];this.fire=function(n){for(var r=0;r<t.length;r++)t[r].apply(null,arguments);if(n in e){var r,i=Array.prototype.slice.call(arguments,1);for(r=0;r<e[n].length;r++)e[n][r].apply(null,i)}};var n=this.on=function(t,n){t in e||(e[t]=[]),e[t].push(n)},r=this.onAll=function(t){name in e||(e[name]=[]),e[name].push(t)},i=this.off=function(t,n){if(t in e){var r=e[t].indexOf(n);-1!==r&&e[t].splice(r,1)}},a=this.offAll=function(e){var n=t.indexOf(e);-1!==n&&t[name].splice(n,1)};this.endpoint=function(e){return e=e||{},e.on=n,e.onAll=r,e.off=i,e.offAll=a,e}}function d(t,n,r){t.listeners=t.listeners||{},t.listeners[n]=t.listeners[n]||[],t.listeners[n].push(r),t.addEventListener(n,r,t!==e)}function f(t,n){t.listeners&&t.listeners[n]&&t.listeners[n].forEach(function(r){t.removeEventListener(n,r,t!==e)})}function g(e,t){return 2>e?e:e*g(e-(t||1))}function w(e,t){return e+t}function v(e){return e.reduce(function(e,t){return e+t},0)}function m(e){return e.toString().split(/(?=(?:\d\d\d)*$)/).join(",")}function b(e){return!_(parseFloat(e))}function y(e){var t=parseFloat(e);return _(t)?e:t}function x(e){var t=parseFloat(e);return _(t)?e?1:0:t}function M(e){return e}function C(e,t){t=t||{};for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function S(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=e[n]||t[n]);return e}function _(t){return e.isNaN(t)}n.prototype.register=function(e,t){this.sheets[t.toUpperCase()]=e,e.name=t},n.prototype.lookup=function(e,t){return e=e.toUpperCase(),e in this.sheets?this.sheets[e].getCalculatedValueAtID(t):null},n.prototype.setDependency=function(e,t,n,r,i){if(n=n.toUpperCase(),n in this.sheets){var a=e.name.toUpperCase()+"!"+t;this.dependencies[a]=this.dependencies[a]||[];var s=function(e,t){("value"!==t||"="!==e[0])&&i(e)};this.dependencies[a].push([n,r,s]),this.sheets[n].valueUpdates.on(r,s),this.sheets[n].calculatedUpdates.on(r,s)}},n.prototype.clearDependencies=function(e,t){var n=e.name.toUpperCase()+"!"+t;n in this.dependencies&&(this.dependencies[n].forEach(function(e){this.sheets[e[0]].valueUpdates.off(e[1],e[2]),this.sheets[e[0]].calculatedUpdates.off(e[1],e[2])},this),this.dependencies[n]=[])},l.WebSheetContext=n;var A=/^(true|false)/i,k=/^"([^\\]|\\.)*"/i,U=/^(\$?)(\w+)(\$?)(\d+)/i,E=/^\-?((([1-9][0-9]*\.|0\.)[0-9]+)|([1-9][0-9]*)|0)/,R=/^(\/|\*|\^)/,P=/^(\+|\-|&)/,F=/^(<>|=|>=|<=|<|>)/,V=/^(\w+)\(/,D=/^(\w+)!/,N=/^\)/,O=/^\(/,q=/^,/,L=/^:/,T=/^%/,W=/^\s+/,Q={};i(Math,"abs"),i(Math,"acos"),i(Math,"acosh"),i(Math,"asin"),i(Math,"asinh"),i(Math,"atan"),i(Math,"atan2"),i(Math,"atanh"),i(Math,"ceil"),i(Math,"ceil","ceiling"),i(Math,"cos"),i(Math,"cosh"),i(Math,"exp"),i(Math,"floor","int"),i(Math,"floor"),i(Math,"log","ln"),i(Math,"log10","log10"),i(Math,"pow","power"),i(Math,"pow"),i(Math,"random","rand"),i(Math,"random"),i(Math,"sin"),i(Math,"sinh"),i(Math,"sqrt"),i(Math,"tan"),i(Math,"tanh"),i(String,"fromCharCode","char"),o.prototype.walk=function(e){if(e(this)!==!1)switch(this.type){case"range":return this.start.walk(e),void this.end.walk(e);case"function":return void this.args.forEach(function(t){t.walk(e)});case"sheetlookup":return void this.content.walk(e);case"binop_mult":case"binop_div":case"binop_add":case"binop_sub":case"binop_concat":case"binop_expon":this.left.walk(e),this.right.walk(e)}},o.prototype.toString=function(){switch(this.type){case"boolean":return this.value?"true":"false";case"string":return JSON.stringify(this.value);case"number":return this.raw.toString();case"identifier":return this.raw.toUpperCase();case"sheetlookup":return this.sheet+"!"+this.content.toString();case"range":return this.start.toString()+":"+this.end.toString();case"function":return this.name+"("+this.args.map(function(e){return e.toString()}).join(",")+")";case"binop_mult":return this.left.toString()+"*"+this.right.toString();case"binop_div":return this.left.toString()+"/"+this.right.toString();case"binop_add":return this.left.toString()+"+"+this.right.toString();case"binop_sub":return this.left.toString()+"-"+this.right.toString();case"binop_concat":return this.left.toString()+"&"+this.right.toString();case"binop_expon":return this.left.toString()+"^"+this.right.toString()}},o.prototype.clone=function(){switch(this.type){case"boolean":case"string":return new o(this.type,{value:this.value});case"number":return new o(this.type,{value:this.value,raw:this.raw});case"identifier":return new o(this.type,{value:this.value,pinRow:this.pinRow,pinCol:this.pinCol,raw:this.raw});case"sheetlookup":return new o(this.type,{sheet:this.sheet,content:this.content.clone()});case"range":return new o(this.type,{start:this.start.clone(),end:this.end.clone()});case"function":return new o(this.type,{name:this.name,args:this.args.map(function(e){return e.clone()})});case"binop_mult":case"binop_div":case"binop_add":case"binop_sub":case"binop_concat":case"binop_expon":return new o(this.type,{left:this.left.clone(),right:this.right.clone()})}},o.prototype.adjust=function(e,t){this.walk(function(n){if("identifier"===n.type){var r=u(n.value),i=r.row+(n.pinRow?0:e),a=r.col+(n.pinCol?0:t);n.value=c(i,a);var s=U.exec(n.value);n.raw=(n.pinCol?"$":"")+s[2]+(n.pinRow?"$":"")+s[4]}})},o.prototype.findCellDependencies=function(e){this.walk(function(t){if("identifier"===t.type)e(t.value);else if("range"===t.type)h(t,function(t,n){e(c(t,n))});else if("sheetlookup"===t.type)return!1})},o.prototype.findSheetDependencies=function(e){this.walk(function(t){return"sheetlookup"===t.type?(t.content.findCellDependencies(function(n){e(t.sheet,n)}),!1):void 0})},o.prototype.run=function(e){switch(this.type){case"boolean":case"number":case"string":return this.value;case"identifier":return y(e.getCalculatedValueAtID(this.value))||0;case"sheetlookup":if(!e.context)throw new Error("Cross-sheet lookup in single-sheet context");var t=e.context.sheets[this.sheet.toUpperCase()];return t?this.content.run(t):null;case"binop_mult":return this.left.run(e)*this.right.run(e);case"binop_div":return this.left.run(e)/this.right.run(e);case"binop_add":return parseFloat(this.left.run(e))+parseFloat(this.right.run(e));case"binop_sub":return this.left.run(e)-this.right.run(e);case"binop_concat":return this.left.run(e).toString()+this.right.run(e).toString();case"binop_expon":return Math.pow(this.left.run(e),this.right.run(e));case"binop_comp_lt":return parseFloat(this.left.run(e))<parseFloat(this.right.run(e));case"binop_comp_lte":return parseFloat(this.left.run(e))<=parseFloat(this.right.run(e));case"binop_comp_gt":return parseFloat(this.left.run(e))>parseFloat(this.right.run(e));case"binop_comp_gte":return parseFloat(this.left.run(e))>=parseFloat(this.right.run(e));case"binop_comp_eq":return this.left.run(e)==this.right.run(e);case"binop_comp_neq":return this.left.run(e)!=this.right.run(e);case"range":var n=[];return h(this,function(t,r){n.push(y(e.getCalculatedValueAtPos(t,r)))}),n}if("function"!==this.type)throw new TypeError("Unknown exression node");return a(this.name,this.args)};var $=100,j=1,I=0,B=1,K=2,z={width:6,height:6};l.prototype.getCell=function(e){return e in this.cellCache?this.cellCache[e]:this.cellCache[e]=this.elem.querySelector('[data-id="'+e+'"]')},l.prototype.forceRerender=function(){var e=v(this.columnWidths);for(e+=j,this.elem.style.width=e+"px";this.elem.childNodes.length;)this.elem.removeChild(this.elem.firstChild);this.cellCache={};for(var n,r,i,a,s,o,h,l,u=[],p=0;p<this.height;p++){n=t.createElement("div"),n.style.width=e+"px",n.className="websheet-row",1>p&&(n.className+=" websheet-row-sticky"),this.elem.appendChild(n),r=this.data[p]||[],i=this.calculated[p]||[],a=this.formatting[p]||[];for(var d=0;d<this.width;d++)if(s=t.createElement("input"),s.className="websheet-cell",o=t.createElement("div"),o.className="websheet-cell-wrapper",o.style.width=this.columnWidths[d]-1+"px",o.appendChild(s),n.appendChild(o),s.value=i[d]||r[d]||"",s.setAttribute("data-id",s.title=c(p,d)),s.setAttribute("data-id-prev-col",c(p,d-1)),s.setAttribute("data-id-prev-row",c(p-1,d)),s.setAttribute("data-id-next-col",c(p,d+1)),s.setAttribute("data-id-next-row",c(p+1,d)),s.setAttribute("data-row",p),s.setAttribute("data-col",d),"="===s.value[0]&&u.push(function(e,t,n){this.setValueAtPosition(t,n,e.value,!0)}.bind(this,s,p,d)),h=a[d])for(l in h)h.hasOwnProperty(l)&&(s.style[l]=h[l])}this.initEvents(),u.forEach(function(e){e()})},l.prototype.getCalculatedValueAtID=function(e){var t=u(e);return this.getCalculatedValueAtPos(t.row,t.col)},l.prototype.getCalculatedValueAtPos=function(e,t){return(this.calculated[e]||[])[t]||(this.data[e]||[])[t]},l.prototype.getValueAtPos=function(e,t){return(this.data[e]||[])[t]||null},l.prototype.setValueAtPosition=function(e,t,n,r){var i=c(e,t),a=this.getCell(i);this.data[e]=this.data[e]||[],(this.data[e][t]!==n||r)&&(this.data[e][t]=n,this.calculated[e]&&delete this.calculated[e][t],this.clearDependants(i),this.valueUpdates.fire(i,n,"value"),"="===n[0]?this.calculateValueAtPosition(e,t,n.substr(1)):(this.updateDependencies(i),a&&(a.value=n)))},l.prototype.calculateValueAtPosition=function(e,t,n){if(n){var i,a=c(e,t),s=r(n);try{i=s.run(this),_(i)&&(i="#VALUE!")}catch(o){console.error(o),i="#ERROR!",s=null}this.calculated[e]=this.calculated[e]||[];var h=this.calculated[e][t]!==i;h&&(this.calculated[e][t]=i);var l=[];if(s&&(s.findCellDependencies(function(e){if(-1===l.indexOf(e)){l.push(e);var t;e in this.dependencies?(t=this.dependencies[e])&&-1===t.indexOf(a)&&t.push(a):this.dependencies[e]=[a]}}.bind(this)),this.context)){this.context.clearDependencies(this,a);var u=[];s.findSheetDependencies(function(r,i){if(this.context.sheets[r.toUpperCase()]){var s=r+"!"+i;-1===u.indexOf(s)&&(u.push(s),this.context.setDependency(this,a,r,i,function(){this.calculateValueAtPosition(e,t,n)}.bind(this)))}}.bind(this))}this.dependants[a]=l,this.getCell(a).value=i,h&&(this.updateDependencies(a),this.calculatedUpdates.fire(a,i,"calculated"))}},l.prototype.clearCell=function(e,t){var n=c(e,t),r=this.getCell(n);r&&(r.value="",e in this.data&&delete this.data[e][t],e in this.calculated&&delete this.calculated[e][t],this.clearDependants(n),this.dependants[n]=[])},l.prototype.loadData=function(e){for(;this.height<e.length;)this.addRow();for(;this.width<e[0].length;)this.addColumn();for(var t=0;t<e.length;t++){this.data[t]=this.data[t]||[];for(var n=0;n<e[t].length;n++)this.data[t][n]=e[t][n]}this.forceRerender()},l.prototype.clearDependants=function(e){var t=this.dependants[e];if(t){for(var n,r,i=0;i<t.length;i++)n=this.dependencies[t[i]],n&&(r=n.indexOf(e),-1!==r&&n.splice(r,1));this.context&&this.context.clearDependencies(this,e)}},l.prototype.updateDependencies=function(e){var t=this.dependencies[e];if(t){var n;if(this.depUpdateQueue)for(var r=0;r<t.length;r++)-1===this.depUpdateQueue.indexOf(t[r])&&this.depUpdateQueue.push(t[r]);else{this.depUpdateQueue=t.concat([]);for(var r=0;r<t.length;r++)this.depUpdateQueue.push(t[r]);for(;this.depUpdateQueue.length;)n=u(this.depUpdateQueue.shift()),this.calculateValueAtPosition(n.row,n.col,this.data[n.row][n.col].substr(1));this.depUpdateQueue=null}}},l.prototype.initEvents=function(){f(this.elem,"focus"),d(this.elem,"focus",this.onFocus.bind(this)),f(this.elem,"blur"),d(this.elem,"blur",this.onBlur.bind(this)),f(this.elem,"keyup"),d(this.elem,"keyup",this.onKeyup.bind(this)),f(this.elem,"keydown"),d(this.elem,"keydown",this.onKeydown.bind(this)),f(this.elem,"mousedown"),d(this.elem,"mousedown",this.onMousedown.bind(this)),f(this.elem,"mouseup"),d(this.elem,"mouseup",this.onMouseup.bind(this)),f(this.elem,"mouseover"),d(this.elem,"mouseover",this.onMouseover.bind(this))},l.prototype.onFocus=function(e){var t=0|e.target.getAttribute("data-row"),n=0|e.target.getAttribute("data-col");e.target.value=(this.data[t]||[])[n]||"",e.target.select(0,e.target.value.length),e.target.parentNode.className="websheet-cell-wrapper websheet-has-focus"},l.prototype.onBlur=function(e){var t=0|e.target.getAttribute("data-row"),n=0|e.target.getAttribute("data-col");this.setValueAtPosition(t,n,e.target.value),this.calculated[t]&&n in this.calculated[t]&&(e.target.value=this.calculated[t][n]),e.target.parentNode.className="websheet-cell-wrapper"},l.prototype.onKeydown=function(e){var t;37===e.keyCode&&0===e.target.selectionStart?t=this.getCell(e.target.getAttribute("data-id-prev-col")):39===e.keyCode&&e.target.selectionEnd===e.target.value.length&&(t=this.getCell(e.target.getAttribute("data-id-next-col"))),t&&(t.focus(),e.preventDefault())},l.prototype.onKeyup=function(e){var t;13===e.keyCode||40===e.keyCode?t=this.getCell(e.target.getAttribute("data-id-next-row")):38===e.keyCode&&(t=this.getCell(e.target.getAttribute("data-id-prev-row"))),t&&t.focus()},l.prototype.onMousedown=function(e){var t,n,r=e.target;if(r.classList.contains("websheet-has-focus")){if(e.preventDefault(),t=this.dragSource=r.firstChild.getAttribute("data-id"),n=u(t),this.setValueAtPosition(n.row,n.col,r.firstChild.value),e.layerX>r.clientWidth-10&&e.layerY>r.clientHeight-10)return void(this.dragType=K);this.dragType=B,this.elem.className+=" websheet-grabbing"}},l.prototype.onMouseup=function(e){var t,n,i=e.target;if(this.dragType&&i.classList.contains("websheet-cell"))if(t=u(this.dragSource),n=u(i.getAttribute("data-id")),this.dragType===B)this.setValueAtPosition(n.row,n.col,this.getValueAtPos(t.row,t.col)||""),this.clearCell(t.row,t.col),e.target.focus();else if(this.dragType===K&&(t.row===n.row||t.col===n.col)){var a,s,o,h=this.getValueAtPos(t.row,t.col)||"",l="="===h[0]&&r(h.substr(1));if(t.row===n.row)for(o=Math.min(t.col,n.col),a=o;a<=Math.max(t.col,n.col);a++)a!==t.col&&(l?(s=l.clone(),s.adjust(0,a-o),this.setValueAtPosition(t.row,a,"="+s.toString())):this.setValueAtPosition(t.row,a,h));else if(t.col===n.col)for(o=Math.min(t.row,n.row),a=o;a<=Math.max(t.row,n.row);a++)a!==t.row&&(l?(s=l.clone(),s.adjust(a-o,0),this.setValueAtPosition(a,t.col,"="+s.toString())):this.setValueAtPosition(a,t.col,h));else console.error("Cannot drag handle diagonally")}this.elem.className="websheet",this.dragType=0,this.dragSource=null;for(var c=this.elem.querySelectorAll(".websheet-cell-hover"),a=0;a<c.length;a++)c[a].classList.remove("websheet-cell-hover")},l.prototype.onMouseover=function(e){if(this.dragType&&e.target.classList.contains("websheet-cell")){for(var t=[],n=this.elem.querySelectorAll(".websheet-cell-hover"),r=0;r<n.length;r++)t.push(n[r].firstChild.dataset.id);var i=e.target.dataset.id;if(i!==this.dragSource){if(this.dragType===K){var a,s,o=u(i),h=u(this.dragSource);if(o.col===h.col)for(r=Math.min(h.row,o.row);r<=Math.max(h.row,o.row);r++)a=c(r,h.col),-1!==(s=t.indexOf(a))?t.splice(s,1):this.getCell(a).parentNode.classList.add("websheet-cell-hover");else if(o.row===h.row)for(r=Math.min(h.col,o.col);r<=Math.max(h.col,o.col);r++)a=c(h.row,r),-1!==(s=t.indexOf(a))?t.splice(s,1):this.getCell(a).parentNode.classList.add("websheet-cell-hover")}else e.target.parentNode.classList.add("websheet-cell-hover");t.forEach(function(e){this.getCell(e).parentNode.classList.remove("websheet-cell-hover")},this)}}},l.prototype.addColumn=function(){this.width+=1,this.columnWidths.push($),this.forceRerender()},l.prototype.addRow=function(){this.height+=1,this.data.push(new Array(this.width)),this.calculated.push(new Array(this.width)),this.formatting.push(new Array(this.width)),this.forceRerender()},l.prototype.insertColumnBefore=function(e){this.width+=1,this.columnWidths.splice(e,0,$);for(var t=0;t<this.height;t++)this.data[t]&&this.data[t].splice(e,0,null),this.calculated[t]&&this.calculated[t].splice(e,0,null),this.formatting[t]&&this.formatting[t].splice(e,0,null);this.forceRerender()},l.prototype.insertRowBefore=function(e){this.height+=1,this.data.splice(e,0,new Array(this.width)),this.calculated.splice(e,0,new Array(this.width)),this.formatting.splice(e,0,new Array(this.width)),this.forceRerender()},l.prototype.popColumn=function(){if(this.width<2)throw new Error("Cannot make spreadsheet that small");this.width-=1,this.columnWidths.pop();for(var e=0;e<this.height;e++)this.data[e]&&this.data[e].length>this.width&&this.data[e].pop(),this.calculated[e]&&this.calculated[e].length>this.width&&this.calculated[e].pop(),this.formatting[e]&&this.formatting[e].length>this.width&&this.formatting[e].pop();this.forceRerender()},l.prototype.popRow=function(){if(this.height<2)throw new Error("Cannot make spreadsheet that small");this.height-=1,this.data.pop(),this.calculated.pop(),this.formatting.pop(),this.forceRerender()},l.prototype.removeColumn=function(e){if(this.width<2)throw new Error("Cannot make spreadsheet that small");if(0>e||e>=this.width)throw new Error("Removing cells that do not exist");this.width-=1,this.columnWidths.splice(e,1);for(var t=0;t<this.height;t++)this.data[t]&&this.data[t].splice(e,1),this.calculated[t]&&this.calculated[t].splice(e,1),this.formatting[t]&&this.formatting[t].splice(e,1);this.forceRerender()},l.prototype.removeRow=function(e){if(this.height<2)throw new Error("Cannot make spreadsheet that small");if(0>e||e>=this.width)throw new Error("Removing cells that do not exist");this.height-=1,this.data.splice(e,1),this.calculated.splice(e,1),this.formatting.splice(e,1),this.forceRerender()};var J={};e.define?e.define("websheet",function(){return l}):e.WebSheet=l}(window,document);